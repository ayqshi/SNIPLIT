<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- PWA & Mobile Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SNIPLIT">
    <title>SNIPLIT</title>
    
    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-app: #000000;
            --bg-panel: #0a0a0a;
            --bg-card: #1c1c1e;
            --bg-card-hover: #2c2c2e;
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --accent: #fa2d48; /* Apple Music Red */
            --accent-glow: rgba(250, 45, 72, 0.2);
            --border: #333333;
            
            --sidebar-width: 260px;
            --player-height: 90px;
            --nav-height-mobile: 65px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            user-select: none;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* --- Sidebar (Desktop) / Bottom Nav (Mobile) --- */
        aside {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            z-index: 100;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* Desktop Sidebar */
        @media (min-width: 769px) {
            aside {
                width: var(--sidebar-width);
                height: 100vh;
                padding: 24px;
                position: relative;
            }
            .mobile-nav { display: none; }
        }

        /* Mobile Bottom Nav */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside {
                position: fixed; bottom: 0; left: 0; width: 100%;
                height: calc(var(--nav-height-mobile) + var(--safe-bottom));
                flex-direction: row; justify-content: space-around; padding: 0;
                border-right: none; border-top: 1px solid var(--border);
                padding-bottom: var(--safe-bottom);
            }
            .desktop-only { display: none !important; }
            .mobile-nav { display: flex; flex: 1; justify-content: space-around; align-items: center; width: 100%; height: 100%; }
            .nav-item { flex-direction: column; gap: 4px; padding: 5px; margin: 0; text-align: center; }
            .nav-item span { display: block; font-size: 10px; }
            .nav-item i { font-size: 22px; }
        }

        .brand {
            display: flex; align-items: center; gap: 10px;
            font-size: 22px; font-weight: 800; color: white; margin-bottom: 30px;
        }
        .brand i { color: var(--accent); font-size: 28px; }

        .nav-section { margin-bottom: 24px; }
        .nav-header {
            font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-muted); margin-bottom: 12px; padding-left: 12px;
        }
        
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 12px;
            border-radius: 8px; color: var(--text-muted); cursor: pointer;
            transition: 0.2s; font-size: 14px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(250, 45, 72, 0.15); color: var(--accent); font-weight: 600; }

        /* --- Main View --- */
        main {
            flex: 1; display: flex; flex-direction: column;
            background: linear-gradient(180deg, #111 0%, #000 100%);
            position: relative; overflow: hidden;
            width: 100%;
        }

        header {
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.05);
            z-index: 50;
        }

        .search-bar {
            display: flex; align-items: center; background: #222;
            border-radius: 10px; padding: 8px 16px; width: 320px;
            border: 1px solid transparent; transition: 0.2s;
        }
        .search-bar:focus-within { border-color: var(--accent); background: #2a2a2a; }
        .search-bar input { background: transparent; border: none; color: white; flex: 1; margin-left: 10px; font-size: 14px; }
        .search-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 18px; }
        .search-btn:hover { color: white; }

        .user-actions { display: flex; gap: 20px; align-items: center; }
        .action-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; position: relative; }
        .notification-dot { position: absolute; top: 0; right: 0; width: 8px; height: 8px; background: var(--accent); border-radius: 50%; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #444, #888); cursor: pointer; border: 2px solid #333; }

        /* Content Scroll */
        .content-area {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 24px 24px 140px 24px; /* Space for player */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Mobile Adjustments for Content */
        @media (max-width: 768px) {
            .content-area { padding-bottom: 220px; padding-left: 16px; padding-right: 16px; }
            .search-bar { width: 100%; max-width: 200px; }
            header { padding: 0 16px; }
        }

        /* --- Components --- */
        .hero { display: flex; align-items: flex-end; gap: 24px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #222; }
        .hero-img { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hero-info h1 { margin: 0 0 10px 0; font-size: 32px; }
        .hero-tags span { font-size: 14px; color: var(--text-muted); margin-right: 15px; }

        .section-header { font-size: 22px; font-weight: 700; margin: 30px 0 20px 0; display: flex; justify-content: space-between; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        
        .card { cursor: pointer; transition: transform 0.2s; }
        .card:hover { transform: translateY(-6px); }
        .card-img-wrapper { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.4); margin-bottom: 10px; background: #222; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.2s;
        }
        .card:hover .card-overlay { opacity: 1; }
        .play-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; transform: scale(0.9); transition: 0.2s; }
        .card:hover .play-btn { transform: scale(1); }
        
        .card-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-sub { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Song List */
        .song-list { display: flex; flex-direction: column; }
        .song-row {
            display: flex; align-items: center; padding: 10px; border-radius: 8px;
            transition: 0.15s; border-bottom: 1px solid #1a1a1a;
        }
        .song-row:hover { background: #1a1a1a; }
        .song-row.active { background: rgba(250, 45, 72, 0.1); }
        .song-row.active .song-title { color: var(--accent); }
        .song-num { width: 25px; color: #555; font-size: 14px; text-align: center; }
        .song-thumb { width: 40px; height: 40px; border-radius: 4px; margin-right: 15px; object-fit: cover; background: #333; }
        .song-meta { flex: 1; min-width: 0; }
        .song-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-artist { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-dur { font-size: 12px; color: #555; width: 40px; text-align: right; margin-right: 10px; }
        .song-play { width: 30px; text-align: right; color: var(--text-muted); }

        /* --- Player Bar --- */
        .player-bar {
            position: fixed; bottom: 0; left: var(--sidebar-width); right: 0;
            height: var(--player-height); background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(20px); border-top: 1px solid #333;
            display: flex; align-items: center; padding: 0 24px; z-index: 200;
            transition: transform 0.2s ease;
        }

        @media (max-width: 768px) {
            .player-bar {
                left: 0; bottom: var(--nav-height-mobile); 
                height: 110px; flex-direction: column; padding: 10px 15px; gap: 5px;
                border-bottom: 1px solid #333; /* Ensure separation from nav */
            }
        }

        .p-left { display: flex; align-items: center; width: 25%; gap: 15px; }
        .p-art { width: 50px; height: 50px; border-radius: 6px; background: #222; object-fit: cover; }
        .p-info h4 { margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .p-info p { margin: 2px 0 0 0; font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .p-like { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; transition: 0.2s; }
        .p-like:hover { color: white; }
        .p-like.liked { color: var(--accent); }

        .p-center { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .controls { display: flex; align-items: center; gap: 20px; margin-bottom: 4px; }
        .ctrl { background: none; border: none; color: #b3b3b3; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .ctrl:hover { color: white; }
        .ctrl.active { color: var(--accent); }
        .ctrl-play { width: 32px; height: 32px; border-radius: 50%; background: white; color: black; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        .ctrl-play:hover { transform: scale(1.05); }

        .progress-wrap { width: 100%; max-width: 400px; display: flex; align-items: center; gap: 10px; font-size: 11px; color: #666; }
        .bar-bg { flex: 1; height: 4px; background: #444; border-radius: 2px; cursor: pointer; position: relative; }
        .bar-fill { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: var(--accent); border-radius: 2px; transition: width 0.1s linear; }
        
        .p-right { width: 25%; display: flex; justify-content: flex-end; align-items: center; gap: 15px; }
        .vol-wrap { width: 80px; display: flex; align-items: center; gap: 8px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: white; cursor: pointer; margin-top: -4px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }

        /* Visualizer */
        canvas#viz { width: 100%; height: 30px; margin-top: 2px; opacity: 0; display: none; pointer-events: none; }
        .p-center.playing canvas#viz { display: block; opacity: 1; }

        /* Modal */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px); z-index: 1000; display: none;
            justify-content: center; align-items: center;
        }
        .modal.open { display: flex; animation: fade 0.2s; }
        .modal-content {
            background: #1c1c1e; width: 90%; max-width: 500px; max-height: 80vh;
            border-radius: 16px; overflow: hidden; border: 1px solid #333; display: flex; flex-direction: column;
        }
        .modal-head { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .lyric-line { margin-bottom: 20px; font-size: 18px; color: #777; text-align: center; transition: 0.2s; }
        .lyric-line.active { color: white; font-size: 22px; font-weight: 600; }

        /* Settings Toggle */
        .toggle-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #333; }
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Toast */
        .toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(10px); border: 1px solid #444;
            padding: 12px 24px; border-radius: 30px; color: white; font-size: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Loading Skeleton */
        .skeleton { background: #222; border-radius: 4px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<!-- Sidebar / Bottom Nav -->
<aside>
    <div class="brand desktop-only"><i class="ph-fill ph-waves"></i> SNIPLIT</div>
    
    <div class="nav-section desktop-only">
        <div class="nav-header">Discover</div>
        <div class="nav-item active" onclick="app.router('foryou')">
            <i class="ph ph-sparkle"></i><span>For You</span>
        </div>
        <div class="nav-item" onclick="app.router('browse')">
            <i class="ph ph-compass"></i><span>Browse</span>
        </div>
        <div class="nav-item" onclick="app.router('radio')">
            <i class="ph ph-broadcast"></i><span>Radio</span>
        </div>
    </div>

    <div class="nav-section desktop-only">
        <div class="nav-header">Library</div>
        <div class="nav-item" onclick="app.router('charts')">
            <i class="ph ph-chart-bar"></i><span>Charts</span>
        </div>
        <div class="nav-item" onclick="app.router('podcasts')">
            <i class="ph ph-microphone-stage"></i><span>Podcasts</span>
        </div>
    </div>

    <div style="flex:1" class="desktop-only"></div>

    <div class="nav-section">
        <div class="nav-item desktop-only" onclick="app.router('settings')">
            <i class="ph ph-gear"></i><span>Settings</span>
        </div>
        <div class="nav-item mobile-nav" onclick="app.router('foryou')">
            <i class="ph ph-sparkle"></i><span>For You</span>
        </div>
        <div class="nav-item mobile-nav" onclick="app.router('browse')">
            <i class="ph ph-compass"></i><span>Browse</span>
        </div>
        <div class="nav-item mobile-nav" onclick="app.router('radio')">
            <i class="ph ph-broadcast"></i><span>Radio</span>
        </div>
        <div class="nav-item mobile-nav" onclick="app.router('charts')">
            <i class="ph ph-chart-bar"></i><span>Top 50</span>
        </div>
        <div class="nav-item mobile-nav" onclick="app.router('settings')">
            <i class="ph ph-gear"></i><span>Settings</span>
        </div>
    </div>
</aside>

<!-- Main Content -->
<main>
    <header>
        <div class="search-bar">
            <i class="ph ph-magnifying-glass" style="color: #888;"></i>
            <input type="text" id="search-input" placeholder="Search Artists, Songs, Podcasts...">
            <button class="search-btn" onclick="app.search()"><i class="ph ph-arrow-right"></i></button>
        </div>
        <div class="user-actions desktop-only">
            <button class="action-btn" onclick="app.ui.toast('No new notifications')">
                <i class="ph ph-bell"></i>
            </button>
            <div class="avatar" onclick="app.router('settings')"></div>
        </div>
    </header>

    <div class="content-area" id="content-area">
        <!-- Content Injected via JS -->
    </div>
</main>

<!-- Player Bar -->
<div class="player-bar">
    <div class="p-left">
        <img src="https://picsum.photos/100" class="p-art" id="p-art">
        <div class="p-info">
            <h4 id="p-title">Not Playing</h4>
            <p id="p-artist">Select a track</p>
        </div>
        <button class="p-like" id="p-like" onclick="app.player.toggleLike()"><i class="ph ph-heart"></i></button>
    </div>
    
    <div class="p-center" id="p-center">
        <div class="controls">
            <button class="ctrl" onclick="app.player.toggleShuffle()" id="btn-shuffle"><i class="ph ph-shuffle"></i></button>
            <button class="ctrl" onclick="app.player.prev()"><i class="ph-fill ph-skip-back"></i></button>
            <button class="ctrl-play" id="btn-play" onclick="app.player.toggle()"><i class="ph-fill ph-play"></i></button>
            <button class="ctrl" onclick="app.player.next()"><i class="ph-fill ph-skip-forward"></i></button>
            <button class="ctrl" onclick="app.player.toggleLoop()" id="btn-loop"><i class="ph ph-repeat"></i></button>
        </div>
        <div class="progress-wrap">
            <span id="time-curr">0:00</span>
            <div class="bar-bg" id="prog-bar" onclick="app.player.seek(event)">
                <div class="bar-fill" id="prog-fill"></div>
            </div>
            <span id="time-tot">0:00</span>
        </div>
        <canvas id="viz"></canvas>
    </div>

    <div class="p-right desktop-only">
        <button class="ctrl" onclick="app.player.lyrics()"><i class="ph ph-microphone-stage"></i></button>
        <button class="ctrl"><i class="ph ph-list"></i></button>
        <div class="vol-wrap">
            <i class="ph ph-speaker-high" style="color:#888; font-size:14px;"></i>
            <input type="range" min="0" max="1" step="0.05" value="1" oninput="app.player.vol(this.value)">
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-head">
            <h3 id="modal-title" style="margin:0">Details</h3>
            <button class="ctrl" onclick="app.ui.closeModal()"><i class="ph ph-x" style="font-size:24px"></i></button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<div class="toast" id="toast">Notification</div>
<audio id="audio" crossorigin="anonymous"></audio>

<script>
const app = {
    state: {
        view: 'foryou',
        audio: document.getElementById('audio'),
        isPlaying: false,
        currentTrack: null,
        queue: [],
        queueIndex: -1,
        shuffle: false,
        loop: false,
        audioCtx: null,
        analyser: null,
        // Simple simulation of user preferences for recommendations
        userPreferences: {
            likedGenres: ['Pop', 'Electronic', 'Hip-Hop'],
            recentlyPlayed: []
        }
    },

    init: () => {
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') app.search();
        });

        app.state.audio.addEventListener('timeupdate', app.player.tick);
        app.state.audio.addEventListener('ended', () => {
            if(app.state.loop) {
                app.state.audio.currentTime = 0;
                app.state.audio.play();
            } else {
                app.player.next();
            }
        });

        app.router('foryou');
    },

    router: (view, param = null) => {
        app.state.view = view;
        const c = document.getElementById('content-area');
        
        // Nav Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const active = document.querySelector(`.nav-item[onclick*="'${view}'"]`);
        if(active) active.classList.add('active');

        c.innerHTML = '';
        window.scrollTo(0,0);

        // Render
        if (view === 'foryou') app.views.forYou(c);
        else if (view === 'browse') app.views.browse(c);
        else if (view === 'search') app.views.search(c, param);
        else if (view === 'radio') app.views.radio(c);
        else if (view === 'podcasts') app.views.podcasts(c);
        else if (view === 'charts') app.views.charts(c);
        else if (view === 'settings') app.views.settings(c);
        else if (view === 'artist') app.views.artist(c, param);
    },

    search: () => {
        const q = document.getElementById('search-input').value.trim();
        if(q) app.router('search', q);
    },

    // --- API Layer ---
    api: {
        iTunes: async (term, entity, limit=25) => {
            try {
                const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&media=music&entity=${entity}&limit=${limit}`);
                return await res.json();
            } catch(e) { return {results: []}; }
        },
        // Public streams for Radio
        stations: [
            { name: "BBC Radio 1", url: "http://stream.live.vc.bbcmedia.co.uk/bbc_radio_one", genre: "Pop", img: "https://picsum.photos/200?random=1" },
            { name: "Chillhop Radio", url: "http://stream.zeno.fm/0r0xa792kwzuv", genre: "Lo-Fi", img: "https://picsum.photos/200?random=2" },
            { name: "Classic FM", url: "http://media-the.musicradio.com/ClassicFMMP3", genre: "Classical", img: "https://picsum.photos/200?random=3" },
            { name: "KISS FM", url: "http://tx.sharp-stream.com/icecast.php?mount=kiss100uk", genre: "Dance", img: "https://picsum.photos/200?random=4" },
            { name: "BBC World Service", url: "http://stream.live.vc.bbcmedia.co.uk/bbc_world_service", genre: "News", img: "https://picsum.photos/200?random=5" }
        ]
    },

    // --- Player Logic ---
    player: {
        initAudioContext: () => {
            if (!app.state.audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                app.state.audioCtx = new AudioContext();
                app.state.analyser = app.state.audioCtx.createAnalyser();
                const source = app.state.audioCtx.createMediaElementSource(app.state.audio);
                source.connect(app.state.analyser);
                app.state.analyser.connect(app.state.audioCtx.destination);
                app.state.analyser.fftSize = 64;
                app.player.drawViz();
            } else if(app.state.audioCtx.state === 'suspended') {
                app.state.audioCtx.resume();
            }
        },

        drawViz: () => {
            const cvs = document.getElementById('viz');
            const ctx = cvs.getContext('2d');
            // Fix canvas sizing to prevent layout shift
            cvs.width = cvs.offsetWidth;
            cvs.height = cvs.offsetHeight;
            
            const bufferLength = app.state.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            const draw = () => {
                if(!app.state.isPlaying) return;
                requestAnimationFrame(draw);
                app.state.analyser.getByteFrequencyData(dataArray);
                ctx.clearRect(0, 0, cvs.width, cvs.height);
                const barWidth = (cvs.width / bufferLength) * 2.5;
                let x = 0;
                for(let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 2;
                    ctx.fillStyle = '#fa2d48';
                    ctx.fillRect(x, cvs.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            };
            draw();
        },

        load: (track, queue = []) => {
            app.state.currentTrack = track;
            app.state.queue = queue;
            app.state.queueIndex = queue.findIndex(t => t.trackId === track.trackId);

            // UI Update
            document.getElementById('p-title').innerText = track.trackName || track.name;
            document.getElementById('p-artist').innerText = track.artistName || 'Radio Stream';
            
            // Safe Image Handling
            const imgUrl = app.utils.getSafeArt(track);
            document.getElementById('p-art').src = imgUrl;

            // Audio
            app.state.audio.src = track.previewUrl || track.url;
            app.state.audio.play();
            app.state.isPlaying = true;
            app.player.initAudioContext();
            app.player.updateUI();
            
            // Update Like State
            app.player.updateLikeUI();

            app.ui.toast(`Now Playing: ${track.trackName || track.name}`);
        },

        toggle: () => {
            if(!app.state.audio.src) return;
            if(app.state.isPlaying) {
                app.state.audio.pause();
                app.state.isPlaying = false;
            } else {
                app.state.audio.play();
                app.state.isPlaying = true;
                app.player.initAudioContext();
            }
            app.player.updateUI();
        },

        next: () => {
            if(app.state.queue.length > 0) {
                let nextIdx = app.state.shuffle 
                    ? Math.floor(Math.random() * app.state.queue.length)
                    : app.state.queueIndex + 1;
                
                if(nextIdx >= app.state.queue.length) nextIdx = 0;
                const next = app.state.queue[nextIdx];
                app.player.load(next, app.state.queue);
            } else {
                app.ui.toast('End of Queue');
            }
        },

        prev: () => {
            if(app.state.queue.length > 0) {
                let prevIdx = app.state.queueIndex - 1;
                if(prevIdx < 0) prevIdx = app.state.queue.length - 1;
                const prev = app.state.queue[prevIdx];
                app.player.load(prev, app.state.queue);
            }
        },

        toggleShuffle: () => {
            app.state.shuffle = !app.state.shuffle;
            document.getElementById('btn-shuffle').classList.toggle('active');
            app.ui.toast(`Shuffle ${app.state.shuffle ? 'On' : 'Off'}`);
        },

        toggleLoop: () => {
            app.state.loop = !app.state.loop;
            document.getElementById('btn-loop').classList.toggle('active');
            app.ui.toast(`Loop ${app.state.loop ? 'On' : 'Off'}`);
        },

        toggleLike: () => {
            if(!app.state.currentTrack) return;
            
            // Logic: If liked, remove from prefs. If not, add genre to prefs
            const btn = document.getElementById('p-like');
            const isLiked = btn.classList.contains('liked');
            
            if(isLiked) {
                btn.classList.remove('liked');
                btn.querySelector('i').className = 'ph ph-heart';
                app.ui.toast('Removed from Liked Songs');
            } else {
                btn.classList.add('liked');
                btn.querySelector('i').className = 'ph-fill ph-heart';
                
                // Simulating Recommendation Algorithm update
                if(app.state.currentTrack.primaryGenreName) {
                    app.state.userPreferences.likedGenres.push(app.state.currentTrack.primaryGenreName);
                }
                app.ui.toast('Added to Liked Songs');
            }
        },

        updateLikeUI: () => {
            const btn = document.getElementById('p-like');
            // For demo, assume not liked until clicked
            btn.classList.remove('liked');
            btn.querySelector('i').className = 'ph ph-heart';
        },

        tick: () => {
            const cur = app.state.audio.currentTime;
            const dur = app.state.audio.duration || 0;
            const pct = dur > 0 ? (cur/dur)*100 : 0;
            document.getElementById('prog-fill').style.width = `${pct}%`;
            document.getElementById('time-curr').innerText = app.fmt(cur);
            document.getElementById('time-tot').innerText = app.fmt(dur);
        },

        seek: (e) => {
            const bg = document.getElementById('prog-bar');
            const rect = bg.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const pct = x / rect.width;
            const dur = app.state.audio.duration || 30;
            app.state.audio.currentTime = pct * dur;
        },

        vol: (v) => { app.state.audio.volume = v; },

        lyrics: () => {
            if(!app.state.currentTrack) { app.ui.toast('No song playing'); return; }
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            document.getElementById('modal-title').innerText = 'Lyrics';
            modal.classList.add('open');
            
            const t = app.state.currentTrack.trackName;
            const imgUrl = app.utils.getSafeArt(app.state.currentTrack);
            
            body.innerHTML = `
                <div style="text-align:center; margin-bottom:20px;">
                    <img src="${imgUrl}" style="width:120px; border-radius:8px; margin-bottom:10px;">
                    <h2>${t}</h2>
                    <p style="color:#888">${app.state.currentTrack.artistName}</p>
                </div>
                <div class="lyrics-container">
                    <p class="lyric-line">[Simulated Lyrics]</p>
                    <p class="lyric-line">Searching for the sound of ${t}</p>
                    <p class="lyric-line">Feeling the rhythm in the air tonight</p>
                    <p class="lyric-line active">Music takes us everywhere we go</p>
                    <p class="lyric-line">Just close your eyes and feel the flow</p>
                    <p class="lyric-line">[Chorus]</p>
                    <p class="lyric-line">Oh oh oh...</p>
                    <p class="lyric-line">Streaming through the digital waves</p>
                </div>
            `;
        },

        updateUI: () => {
            const btn = document.getElementById('btn-play');
            const center = document.getElementById('p-center');
            if(app.state.isPlaying) {
                btn.innerHTML = '<i class="ph-fill ph-pause"></i>';
                center.classList.add('playing');
            } else {
                btn.innerHTML = '<i class="ph-fill ph-play"></i>';
                center.classList.remove('playing');
            }
        }
    },

    // --- Views ---
    views: {
        forYou: async (c) => {
            // Recommendation Logic: Pick a random liked genre and search it
            const genre = app.state.userPreferences.likedGenres[Math.floor(Math.random() * app.state.userPreferences.likedGenres.length)];
            
            c.innerHTML = `
                <h2 style="margin:0 0 20px 0">For You</h2>
                <p style="color:#888; font-size:14px; margin-bottom:20px;">Based on your interest in ${genre}</p>
                <div class="grid" id="rec-grid">
                    <div class="skeleton" style="height:200px; grid-column:span 3"></div>
                </div>
            `;
            
            const res = await app.api.iTunes(genre, 'song', 12);
            const grid = document.getElementById('rec-grid');
            grid.innerHTML = '';
            if(res.results.length) {
                res.results.forEach(r => grid.appendChild(app.ui.card(r)));
            } else {
                grid.innerHTML = '<div style="color:#666">Listen to some music to get recommendations!</div>';
            }
        },

        browse: (c) => {
            const genres = [
                {name:'Pop', col:'#8e44ad'}, {name:'Hip-Hop', col:'#2c3e50'}, {name:'Rock', col:'#c0392b'},
                {name:'Electronic', col:'#2980b9'}, {name:'Jazz', col:'#d35400'}, {name:'Classical', col:'#7f8c8d'}
            ];
            let html = `<h2>Browse Genres</h2><div class="grid">`;
            genres.forEach(g => {
                html += `<div style="background:linear-gradient(135deg, ${g.col}, #000); aspect-ratio:1; border-radius:8px; padding:20px; cursor:pointer; transition:0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'" onclick="app.router('search','${g.name}')"><h2 style="margin:0">${g.name}</h2></div>`;
            });
            html += '</div>';
            c.innerHTML = html;
        },

        search: async (c, term) => {
            c.innerHTML = `<h2>Results for "${term}"</h2><div style="margin-bottom:20px; color:#888">Searching...</div>`;
            
            // Fetch Songs, Artists, Podcasts
            const songs = await app.api.iTunes(term, 'song', 10);
            const artists = await app.api.iTunes(term, 'musicArtist', 5);
            const podcasts = await app.api.iTunes(term, 'podcast', 5);

            let html = '';

            // Artists
            if(artists.results.length) {
                html += `<h3>Artists</h3><div class="grid" style="margin-bottom:30px">`;
                artists.results.forEach(a => {
                    const imgUrl = a.artworkUrl100 ? a.artworkUrl100.replace('100x100','400x400') : 'https://picsum.photos/200';
                    html += `<div class="card" onclick="app.router('artist','${a.artistName}')">
                        <div class="card-img-wrapper"><img src="${imgUrl}" class="card-img" style="border-radius:50%"></div>
                        <div class="card-title" style="text-align:center">${a.artistName}</div><div class="card-sub" style="text-align:center">Artist</div>
                    </div>`;
                });
                html += '</div>';
            }

            // Songs
            if(songs.results.length) {
                html += `<h3>Songs</h3><div class="song-list">`;
                songs.results.forEach(s => html += app.ui.songRow(s));
                html += '</div>';
            }

            // Podcasts
            if(podcasts.results.length) {
                html += `<h3 style="margin-top:30px">Podcasts</h3><div class="grid">`;
                podcasts.results.forEach(p => {
                    const imgUrl = p.artworkUrl600 || p.artworkUrl100 || 'https://picsum.photos/200';
                    html += `<div class="card">
                        <div class="card-img-wrapper"><img src="${imgUrl}" class="card-img"></div>
                        <div class="card-title">${p.collectionName}</div><div class="card-sub">${p.artistName}</div>
                    </div>`;
                });
                html += '</div>';
            }

            if(!html) html = '<div style="color:#666">No results found.</div>';
            c.innerHTML = html;
        },

        artist: async (c, name) => {
            c.innerHTML = `<div class="loading">Loading Artist...</div>`;
            const res = await app.api.iTunes(name, 'song', 20);
            const songs = res.results;
            const imgUrl = songs.length && songs[0].artworkUrl100 ? songs[0].artworkUrl100.replace('100x100','600x600') : 'https://picsum.photos/200';

            c.innerHTML = `
                <div class="hero">
                    <img src="${imgUrl}" class="hero-img">
                    <div class="hero-info">
                        <h1>${name}</h1>
                        <div class="hero-tags"><span>Artist</span><span>${songs.length} Songs</span></div>
                    </div>
                </div>
                <div class="song-list">
                    ${songs.map(s => app.ui.songRow(s, songs)).join('')}
                </div>
            `;
        },

        radio: (c) => {
            c.innerHTML = `<h2>Live Radio</h2><div class="grid">`;
            app.api.stations.forEach(s => {
                c.innerHTML += `<div class="card" onclick="app.player.load(${JSON.stringify(s)})">
                    <div class="card-img-wrapper">
                        <img src="${s.img}" class="card-img">
                        <div class="play-overlay"><div class="play-btn"><i class="ph-fill ph-broadcast"></i></div></div>
                    </div>
                    <div class="card-title">${s.name}</div>
                    <div class="card-sub">${s.genre}</div>
                </div>`;
            });
            c.innerHTML += '</div>';
        },

        podcasts: async (c) => {
            c.innerHTML = `<h2>Trending Podcasts</h2><div class="grid" id="pod-grid">Loading...</div>`;
            const res = await app.api.iTunes('news', 'podcast', 12);
            const g = document.getElementById('pod-grid');
            g.innerHTML = '';
            res.results.forEach(p => {
                const imgUrl = p.artworkUrl600 || p.artworkUrl100 || 'https://picsum.photos/200';
                g.innerHTML += `<div class="card">
                    <div class="card-img-wrapper"><img src="${imgUrl}" class="card-img"></div>
                    <div class="card-title">${p.collectionName}</div>
                    <div class="card-sub">${p.artistName}</div>
                </div>`;
            });
        },

        charts: async (c) => {
            c.innerHTML = `<h2>Top Charts</h2><div class="song-list" id="chart-list">Loading...</div>`;
            const res = await app.api.iTunes('top', 'album', 10);
            const l = document.getElementById('chart-list');
            l.innerHTML = '';
            res.results.forEach((r, i) => {
                // Mock song for album chart
                const song = { trackName: r.collectionName, artistName: r.artistName, artworkUrl100: r.artworkUrl100, previewUrl: r.previewUrl, trackId: r.collectionId };
                l.innerHTML += app.ui.songRow(song, res.results, i+1);
            });
        },

        settings: (c) => {
            c.innerHTML = `<h2>Settings</h2>
            <div class="toggle-row"><span>High Quality Streaming</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
            <div class="toggle-row"><span>Data Saver</span><label class="switch"><input type="checkbox"><span class="slider"></span></label></div>
            <div class="toggle-row"><span>Show Explicit</span><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></div>
            <br>
            <button class="search-btn" style="padding:10px 20px; background:#333; border-radius:8px;" onclick="localStorage.clear(); location.reload()">Reset App Data</button>
            `;
        }
    },

    utils: {
        // Safe extraction of artwork to prevent the "reading 'replace' of undefined" crash
        getSafeArt: (item) => {
            if (!item) return 'https://picsum.photos/200';
            
            // Priority: artworkUrl100 -> artworkUrl600 -> collection -> fallback
            let url = item.artworkUrl100 || item.artworkUrl600 || item.collectionViewUrl;
            
            if (url) {
                return url.replace('100x100', '400x400').replace('600x600', '400x400');
            }
            // Random seed based on track ID for consistency
            return `https://picsum.photos/seed/${item.trackId || 'music'}/400`;
        },
        
        getSafeUrl: (item) => {
            return item.previewUrl || item.url || '';
        }
    },

    ui: {
        card: (item) => {
            const d = document.createElement('div');
            d.className = 'card';
            d.onclick = () => app.router('artist', item.artistName);
            const imgUrl = app.utils.getSafeArt(item);
            
            d.innerHTML = `
                <div class="card-img-wrapper">
                    <img src="${imgUrl}" class="card-img">
                    <div class="play-overlay"><div class="play-btn"><i class="ph-fill ph-play"></i></div></div>
                </div>
                <div class="card-title">${item.collectionName || item.trackName}</div>
                <div class="card-sub">${item.artistName}</div>
            `;
            return d;
        },
        songRow: (s, queue=[], rank=null) => {
            const active = app.state.currentTrack?.trackId === s.trackId ? 'active' : '';
            const playIcon = active ? '<i class="ph-fill ph-equalizer" style="color:var(--accent)"></i>' : '<i class="ph ph-play"></i>';
            const imgUrl = app.utils.getSafeArt(s);
            const url = app.utils.getSafeUrl(s);
            
            // Object serialization for inline onclick
            const safeS = { ...s, previewUrl: url, artworkUrl100: imgUrl }; 
            const sStr = JSON.stringify(safeS).replace(/"/g, '&quot;');
            const qStr = JSON.stringify(queue).replace(/"/g, '&quot;');
            
            return `
                <div class="song-row ${active}" onclick="app.player.load(${sStr}, ${qStr})">
                    <div class="song-num">${rank ? rank : ''}</div>
                    <img src="${imgUrl}" class="song-thumb">
                    <div class="song-meta">
                        <div class="song-title">${s.trackName}</div>
                        <div class="song-artist">${s.artistName}</div>
                    </div>
                    <div class="song-dur">0:30</div>
                    <div class="song-play">${playIcon}</div>
                </div>
            `;
        },
        closeModal: () => document.getElementById('modal').classList.remove('open'),
        toast: (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    }
};

const fmt = (s) => {
    const m = Math.floor(s/60);
    const sc = Math.floor(s%60);
    return `${m}:${sc<10?'0':''}${sc}`;
};
app.fmt = fmt;

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
