<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="SNIPLIT HYPER-ULTRA - Next Gen Audio">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SNIPLIT HYPER-ULTRA</title>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-deep: #030303;
            --bg-panel: rgba(15, 15, 20, 0.75);
            --bg-surface: rgba(255, 255, 255, 0.03);
            --bg-surface-hover: rgba(255, 255, 255, 0.08);
            
            --accent: #00f2ea; /* Cyber Cyan */
            --accent-sec: #ff0055; /* Neon Red */
            --text-main: #ffffff;
            --text-muted: #8899a6;
            
            --blur: 40px;
            --sidebar-w: 260px;
            --player-h: 100px;
            --nav-mob: 70px;
            
            --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
            --font-main: 'Space Grotesk', sans-serif;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; user-select: none; }
        
        body {
            background: var(--bg-deep); color: var(--text-main); font-family: var(--font-main);
            height: 100vh; overflow: hidden; display: flex; font-smooth: always;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* --- WEBGL CANVAS BACKGROUND --- */
        #viz-canvas {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            opacity: 0.4; mix-blend-mode: screen;
        }

        /* --- LAYOUT --- */
        #app-root { display: flex; width: 100%; height: 100%; z-index: 1; position: relative; }

        /* SIDEBAR */
        aside {
            width: var(--sidebar-w); height: 100%; background: var(--bg-panel);
            backdrop-filter: blur(var(--blur)); border-right: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; padding: 24px 0; z-index: 50;
            transition: transform 0.3s var(--ease-out);
        }
        .brand {
            padding: 0 24px 30px; font-size: 24px; font-weight: 700; letter-spacing: -1px;
            display: flex; align-items: center; gap: 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent-sec));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .nav-group { margin-bottom: 24px; }
        .nav-head { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: #555; padding: 0 24px 10px; font-weight: 700; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 24px;
            color: var(--text-muted); font-size: 15px; cursor: pointer; transition: 0.2s;
            border-left: 3px solid transparent;
        }
        .nav-item:hover { color: white; background: var(--bg-surface-hover); }
        .nav-item.active { color: white; border-left-color: var(--accent); background: linear-gradient(90deg, rgba(0, 242, 234, 0.1), transparent); }
        .nav-item i { font-size: 20px; }

        /* MAIN CONTENT */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        header {
            height: 80px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 32px; z-index: 20; background: linear-gradient(180deg, rgba(0,0,0,0.8), transparent);
        }
        .search-wrap {
            position: relative; width: 300px;
        }
        .search-inp {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
            padding: 12px 40px; border-radius: 30px; color: white; font-family: inherit;
            transition: 0.3s;
        }
        .search-inp:focus { background: rgba(255,255,255,0.1); border-color: var(--accent); width: 340px; box-shadow: 0 0 20px rgba(0, 242, 234, 0.2); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #666; }

        .user-pill {
            display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05);
            padding: 6px 6px 6px 16px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer; transition: 0.2s;
        }
        .user-pill:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .u-name { font-size: 13px; font-weight: 600; }
        .u-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

        /* VIEW AREA */
        #view-area {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 20px 32px 140px; scroll-behavior: smooth;
        }

        /* COMPONENTS */
        .hero-banner {
            height: 300px; border-radius: 24px; position: relative; overflow: hidden; margin-bottom: 40px;
            display: flex; align-items: flex-end; padding: 40px; border: 1px solid rgba(255,255,255,0.1);
        }
        .hero-bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .hero-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, #000 0%, transparent 100%); }
        .hero-content { position: relative; z-index: 2; width: 100%; }
        .tag-pill { display: inline-block; background: var(--accent); color: black; padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: 800; margin-bottom: 10px; }
        .hero-title { font-size: 48px; font-weight: 800; margin-bottom: 10px; line-height: 1; text-shadow: 0 0 30px rgba(0,0,0,0.5); }
        
        .section-head { font-size: 20px; font-weight: 700; margin: 40px 0 20px; display: flex; align-items: center; gap: 10px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 24px; }
        .card {
            background: var(--bg-surface); padding: 16px; border-radius: 16px; cursor: pointer;
            transition: 0.3s var(--ease-out); position: relative; border: 1px solid transparent;
        }
        .card:hover { background: var(--bg-surface-hover); transform: translateY(-8px); border-color: rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .card-img-wrap { position: relative; border-radius: 12px; overflow: hidden; margin-bottom: 14px; aspect-ratio: 1; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .card:hover .card-img { transform: scale(1.05); }
        .play-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: 0.2s; backdrop-filter: blur(2px);
        }
        .card:hover .play-overlay { opacity: 1; }
        .play-circle {
            width: 50px; height: 50px; background: var(--accent); border-radius: 50%; color: black;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 0 20px rgba(0, 242, 234, 0.6); transform: scale(0.8); transition: 0.2s;
        }
        .card:hover .play-circle { transform: scale(1); }
        
        .c-title { font-size: 15px; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .c-sub { font-size: 12px; color: var(--text-muted); }

        /* LIST VIEW */
        .list-row {
            display: grid; grid-template-columns: 40px 50px 1fr 60px; align-items: center; gap: 16px;
            padding: 10px 16px; border-radius: 8px; border-bottom: 1px solid rgba(255,255,255,0.03);
            transition: 0.2s; cursor: pointer;
        }
        .list-row:hover { background: rgba(255,255,255,0.05); }
        .list-row.active { background: rgba(0, 242, 234, 0.1); }
        .list-row.active .l-title { color: var(--accent); }
        .l-num { color: #555; font-size: 12px; text-align: center; }
        .l-img { width: 44px; height: 44px; border-radius: 6px; object-fit: cover; }
        .l-title { font-weight: 600; font-size: 14px; color: white; }
        .l-artist { font-size: 12px; color: #888; }

        /* PLAYER BAR - ADVANCED */
        .player-bar {
            position: fixed; bottom: 0; left: var(--sidebar-w); right: 0; height: var(--player-h);
            background: rgba(10, 10, 12, 0.9); backdrop-filter: blur(30px); border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; padding: 0 32px; z-index: 100; justify-content: space-between;
        }
        .pb-track { display: flex; align-items: center; gap: 16px; width: 30%; }
        .pb-img { width: 60px; height: 60px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); object-fit: cover; }
        
        .pb-controls { width: 40%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .ctrl-btns { display: flex; align-items: center; gap: 24px; margin-bottom: 8px; }
        .btn-act { background: none; border: none; color: #888; cursor: pointer; font-size: 20px; transition: 0.2s; }
        .btn-act:hover { color: white; }
        .btn-act.active { color: var(--accent); text-shadow: 0 0 10px var(--accent); }
        .btn-main {
            width: 44px; height: 44px; background: white; border-radius: 50%; color: black;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
            transition: 0.2s; box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }
        .btn-main:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(255,255,255,0.5); }
        
        .scrubber { width: 100%; display: flex; align-items: center; gap: 12px; font-size: 11px; color: #666; font-family: monospace; }
        .track-bg { flex: 1; height: 4px; background: #333; border-radius: 2px; position: relative; cursor: pointer; overflow: hidden; }
        .track-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-sec)); position: absolute; }
        
        .pb-extra { width: 30%; display: flex; justify-content: flex-end; align-items: center; gap: 16px; }

        /* LOADING SPINNER */
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 50px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MOBILE RESPONSIVE */
        @media (max-width: 900px) {
            aside { transform: translateX(-100%); position: fixed; box-shadow: 0 0 50px black; }
            .player-bar { left: 0; bottom: 70px; height: 80px; padding: 0 16px; }
            .pb-extra { display: none; }
            .pb-track { width: 60%; } .pb-controls { width: 40%; }
            .scrubber, .c-sub { display: none; }
            #mobile-nav { display: flex; }
            header { padding: 0 16px; }
            .search-wrap { display: none; } /* Hide search on mobile for clean UI */
        }
        
        #mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: rgba(5,5,5,0.95); backdrop-filter: blur(20px); border-top: 1px solid #222;
            z-index: 200; justify-content: space-around; align-items: center;
        }
        .mob-link { color: #666; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
        .mob-link.active { color: var(--accent); }
        .mob-link i { font-size: 22px; }

    </style>
</head>
<body>

    <canvas id="viz-canvas"></canvas>

    <aside>
        <div class="brand"><i class="ph-fill ph-waves"></i> SNIPLIT</div>
        
        <div class="nav-group">
            <div class="nav-head">Menu</div>
            <div class="nav-item active" onclick="App.route('foryou')"><i class="ph ph-sparkle"></i> For You</div>
            <div class="nav-item" onclick="App.route('browse')"><i class="ph ph-compass"></i> Browse</div>
            <div class="nav-item" onclick="App.route('radio')"><i class="ph ph-radio"></i> Live Radio</div>
            <div class="nav-item" onclick="App.route('podcasts')"><i class="ph ph-microphone"></i> Podcasts</div>
        </div>

        <div class="nav-group">
            <div class="nav-head">Library</div>
            <div class="nav-item" onclick="App.route('liked')"><i class="ph ph-heart"></i> Liked Songs</div>
            <div class="nav-item" onclick="App.route('history')"><i class="ph ph-clock-counter-clockwise"></i> History</div>
            <div class="nav-item" onclick="App.route('settings')"><i class="ph ph-gear"></i> Settings</div>
        </div>
    </aside>

    <main>
        <header>
            <div class="search-wrap">
                <i class="ph ph-magnifying-glass search-icon"></i>
                <input type="text" class="search-inp" placeholder="Search tracks, artists, podcasts..." onkeydown="if(event.key==='Enter') App.search(this.value)">
            </div>
            <div class="user-pill" onclick="App.route('settings')">
                <img src="https://ui-avatars.com/api/?name=User&background=00f2ea&color=000" class="u-img">
                <span class="u-name">Premium</span>
            </div>
        </header>

        <div id="view-area">
            </div>
    </main>

    <div class="player-bar">
        <div class="pb-track">
            <img src="https://picsum.photos/100" class="pb-img" id="p-img">
            <div>
                <div class="c-title" id="p-title">Ready</div>
                <div class="c-sub" id="p-artist">Select a track</div>
            </div>
        </div>
        
        <div class="pb-controls">
            <div class="ctrl-btns">
                <button class="btn-act" onclick="Audio.toggleShuffle()"><i class="ph ph-shuffle"></i></button>
                <button class="btn-act" onclick="Audio.prev()"><i class="ph-fill ph-skip-back"></i></button>
                <button class="btn-main" onclick="Audio.toggle()" id="play-btn-icon"><i class="ph-fill ph-play"></i></button>
                <button class="btn-act" onclick="Audio.next()"><i class="ph-fill ph-skip-forward"></i></button>
                <button class="btn-act" onclick="Audio.toggleLoop()"><i class="ph ph-repeat"></i></button>
            </div>
            <div class="scrubber">
                <span id="t-cur">0:00</span>
                <div class="track-bg" id="seek-bar"><div class="track-fill" id="seek-fill"></div></div>
                <span id="t-dur">0:00</span>
            </div>
        </div>
        
        <div class="pb-extra">
            <button class="btn-act" id="like-btn" onclick="Audio.like()"><i class="ph ph-heart"></i></button>
            <i class="ph ph-speaker-high" style="color:#888"></i>
            <input type="range" min="0" max="1" step="0.01" style="width:80px" oninput="Audio.el.volume=this.value">
        </div>
    </div>

    <div id="mobile-nav">
        <div class="mob-link active" onclick="App.route('foryou')"><i class="ph ph-house"></i> Home</div>
        <div class="mob-link" onclick="App.route('browse')"><i class="ph ph-compass"></i> Browse</div>
        <div class="mob-link" onclick="App.route('radio')"><i class="ph ph-radio"></i> Radio</div>
        <div class="mob-link" onclick="App.route('liked')"><i class="ph ph-heart"></i> Library</div>
    </div>

    <audio id="audio-core" crossorigin="anonymous"></audio>

<script>
/**
 * SNIPLIT ENGINE 3.0
 * Architecture:
 * 1. State Management: Central store for queue, history, preferences.
 * 2. Intelligence: Weighted tagging system for "For You" personalization.
 * 3. Audio Graph: WebAudio API + Canvas WebGL Visualization.
 * 4. API Aggregator: iTunes (Music/Podcasts) + RadioBrowser (Live).
 */

const Store = {
    queue: [],
    queueIdx: 0,
    history: JSON.parse(localStorage.getItem('sn_hist') || '[]'),
    liked: JSON.parse(localStorage.getItem('sn_like') || '[]'),
    // "Taste Profile": Weights for genres. Clicking a song boosts its genre weight.
    taste: JSON.parse(localStorage.getItem('sn_taste') || '{"Pop":5, "Rock":2, "Electronic":3}'),
    loop: false,
    shuffle: false
};

const API = {
    // Fetches music AND podcasts
    search: async (q, entity='song') => {
        const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(q)}&media=music&entity=${entity}&limit=25`);
        const data = await res.json();
        return data.results.map(i => ({
            id: i.trackId,
            title: i.trackName || i.collectionName,
            artist: i.artistName,
            img: (i.artworkUrl100 || '').replace('100x100', '600x600'),
            audio: i.previewUrl || i.feedUrl, // Preview for songs, feed for podcasts (needs parsing usually, but iTunes returns playable URLs often)
            genre: i.primaryGenreName,
            type: entity
        })).filter(x => x.audio); // Only return playable items
    },
    
    // Improved Radio Fetcher: Filters for MP3/HTTPS to ensure playback works
    radio: async (tag) => {
        const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?limit=20&tag=${tag}&hidebroken=true&order=clickcount&reverse=true&is_https=true&codec=mp3`);
        const data = await res.json();
        return data.map(s => ({
            id: s.stationuuid,
            title: s.name,
            artist: 'Live Station',
            img: s.favicon || `https://ui-avatars.com/api/?name=${encodeURIComponent(s.name)}&background=random`,
            audio: s.url_resolved,
            genre: s.tags,
            type: 'radio'
        }));
    },
    
    podcasts: async () => {
        return await API.search('trending', 'podcast');
    }
};

const Audio = {
    el: document.getElementById('audio-core'),
    ctx: null,
    analyser: null,
    
    initContext: () => {
        if(Audio.ctx) return;
        const Actx = window.AudioContext || window.webkitAudioContext;
        Audio.ctx = new Actx();
        Audio.analyser = Audio.ctx.createAnalyser();
        Audio.analyser.fftSize = 512; // Higher resolution for new viz
        const src = Audio.ctx.createMediaElementSource(Audio.el);
        src.connect(Audio.analyser);
        Audio.analyser.connect(Audio.ctx.destination);
        Viz.start();
    },

    play: (track, newQueue=null) => {
        Audio.initContext();
        if(Audio.ctx.state === 'suspended') Audio.ctx.resume();
        
        if(newQueue) {
            Store.queue = newQueue;
            Store.queueIdx = newQueue.findIndex(t => t.id === track.id);
        }

        Audio.el.src = track.audio;
        Audio.el.play().then(() => {
            Audio.updateUI(true);
            Store.history.unshift(track);
            localStorage.setItem('sn_hist', JSON.stringify(Store.history.slice(0,50)));
            
            // Intelligence: Boost Genre Weight
            if(track.genre) {
                Store.taste[track.genre] = (Store.taste[track.genre] || 0) + 1;
                localStorage.setItem('sn_taste', JSON.stringify(Store.taste));
            }
        }).catch(e => alert("Stream Unavailable (CORS/Format issue)"));

        // Update UI Text
        document.getElementById('p-title').innerText = track.title;
        document.getElementById('p-artist').innerText = track.artist;
        document.getElementById('p-img').src = track.img;
        
        // Update Like Button
        const liked = Store.liked.some(l => l.id === track.id);
        const btn = document.getElementById('like-btn');
        btn.style.color = liked ? 'var(--accent)' : '#888';
        btn.innerHTML = liked ? '<i class="ph-fill ph-heart"></i>' : '<i class="ph ph-heart"></i>';
    },

    toggle: () => {
        if(Audio.el.paused) {
            Audio.el.play();
            Audio.updateUI(true);
        } else {
            Audio.el.pause();
            Audio.updateUI(false);
        }
    },

    updateUI: (isPlaying) => {
        const icon = document.getElementById('play-btn-icon');
        icon.innerHTML = isPlaying ? '<i class="ph-fill ph-pause"></i>' : '<i class="ph-fill ph-play"></i>';
    },

    next: () => {
        let nextIdx = Store.queueIdx + 1;
        if(Store.shuffle) nextIdx = Math.floor(Math.random() * Store.queue.length);
        if(nextIdx >= Store.queue.length) nextIdx = 0; // Loop list
        Audio.play(Store.queue[nextIdx]);
    },

    prev: () => {
        let idx = Store.queueIdx - 1;
        if(idx < 0) idx = Store.queue.length - 1;
        Audio.play(Store.queue[idx]);
    },
    
    like: () => {
        const t = Store.queue[Store.queueIdx];
        if(!t) return;
        const idx = Store.liked.findIndex(l => l.id === t.id);
        if(idx > -1) {
            Store.liked.splice(idx, 1);
        } else {
            Store.liked.unshift(t);
        }
        localStorage.setItem('sn_like', JSON.stringify(Store.liked));
        
        // Refresh UI immediately
        const liked = Store.liked.some(l => l.id === t.id);
        const btn = document.getElementById('like-btn');
        btn.style.color = liked ? 'var(--accent)' : '#888';
        btn.innerHTML = liked ? '<i class="ph-fill ph-heart"></i>' : '<i class="ph ph-heart"></i>';
    },

    toggleShuffle: () => {
        Store.shuffle = !Store.shuffle;
        alert("Shuffle: " + (Store.shuffle ? "ON" : "OFF"));
    },
    
    toggleLoop: () => {
        Store.loop = !Store.loop;
        Audio.el.loop = Store.loop;
        alert("Loop: " + (Store.loop ? "ON" : "OFF"));
    }
};

// Seek Bar Logic
Audio.el.addEventListener('timeupdate', () => {
    const cur = Audio.el.currentTime;
    const dur = Audio.el.duration || 1;
    document.getElementById('seek-fill').style.width = (cur/dur)*100 + '%';
    document.getElementById('t-cur').innerText = fmt(cur);
    document.getElementById('t-dur').innerText = fmt(dur);
});

document.getElementById('seek-bar').addEventListener('click', (e) => {
    const rect = e.target.getBoundingClientRect();
    const pos = (e.clientX - rect.left) / rect.width;
    Audio.el.currentTime = pos * Audio.el.duration;
});

function fmt(s) {
    if(isNaN(s)) return '0:00';
    const m = Math.floor(s/60);
    const sc = Math.floor(s%60);
    return `${m}:${sc<10?'0':''}${sc}`;
}

const Viz = {
    cvs: document.getElementById('viz-canvas'),
    ctx: document.getElementById('viz-canvas').getContext('2d'),
    particles: [],
    
    start: () => {
        Viz.resize();
        window.addEventListener('resize', Viz.resize);
        // Init particles
        for(let i=0; i<100; i++) {
            Viz.particles.push({
                x: Math.random() * Viz.cvs.width,
                y: Math.random() * Viz.cvs.height,
                size: Math.random() * 3,
                speed: Math.random() * 2 + 0.5
            });
        }
        Viz.loop();
    },
    
    resize: () => {
        Viz.cvs.width = window.innerWidth;
        Viz.cvs.height = window.innerHeight;
    },

    loop: () => {
        requestAnimationFrame(Viz.loop);
        const w = Viz.cvs.width;
        const h = Viz.cvs.height;
        Viz.ctx.clearRect(0,0,w,h);
        
        // Get Audio Data
        const buffer = Audio.analyser.frequencyBinCount;
        const data = new Uint8Array(buffer);
        Audio.analyser.getByteFrequencyData(data);
        
        // Calculate Bass Energy (Low Frequencies)
        let bass = 0;
        for(let i=0; i<20; i++) bass += data[i];
        bass /= 20; // Average
        const scale = 1 + (bass / 256); // 1.0 to 2.0 scale factor

        // Draw Particles (High Tech Vortex)
        Viz.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--accent');
        
        Viz.particles.forEach(p => {
            p.y -= p.speed * scale; // Move faster with bass
            if(p.y < 0) p.y = h;
            
            Viz.ctx.beginPath();
            Viz.ctx.arc(p.x, p.y, p.size * (bass/50), 0, Math.PI*2);
            Viz.ctx.globalAlpha = data[Math.floor(p.x % 100)] / 255; // Opacity reacts to frequency
            Viz.ctx.fill();
        });
        
        // Draw Frequency Line (Center)
        Viz.ctx.beginPath();
        Viz.ctx.moveTo(0, h/2);
        for(let i=0; i<buffer; i++) {
            const v = data[i] / 255;
            const y = h/2 - (v * h/4) * scale;
            Viz.ctx.lineTo((i/buffer)*w, y);
        }
        Viz.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        Viz.ctx.lineWidth = 2;
        Viz.ctx.stroke();
    }
};

const App = {
    init: () => {
        App.route('foryou');
    },

    route: async (view) => {
        const c = document.getElementById('view-area');
        
        // Highlight Nav
        document.querySelectorAll('.nav-item, .mob-link').forEach(el => el.classList.remove('active'));
        // Find links
        // (Simplified selector logic for brevity)
        
        c.innerHTML = `<div class="spinner"></div>`;
        
        if(view === 'foryou') {
            // Personalization Engine: Sort genres by weight
            const topGenre = Object.keys(Store.taste).reduce((a, b) => Store.taste[a] > Store.taste[b] ? a : b);
            const mix = await API.search(topGenre + ' mix');
            const recent = await API.search('new music ' + topGenre);
            
            c.innerHTML = `
                <div class="hero-banner">
                    <img src="${mix[0]?.img || 'https://picsum.photos/800/400'}" class="hero-bg">
                    <div class="hero-overlay"></div>
                    <div class="hero-content">
                        <span class="tag-pill">BASED ON YOUR LISTENING</span>
                        <div class="hero-title">${topGenre} Daily Mix</div>
                        <button class="play-circle" style="transform:scale(1); width:60px; height:60px; font-size:24px" 
                            onclick='Audio.play(${JSON.stringify(mix[0]).replace(/'/g,"&apos;")}, ${JSON.stringify(mix).replace(/'/g,"&apos;")})'>
                            <i class="ph-fill ph-play"></i>
                        </button>
                    </div>
                </div>
                <div class="section-head">Considered for You (High Affinity)</div>
                <div class="grid">${recent.map(ui_card).join('')}</div>
                <div class="section-head">Jump Back In</div>
                <div class="grid">${mix.slice(1,5).map(ui_card).join('')}</div>
            `;
        } 
        else if (view === 'radio') {
            const stations = await API.radio('pop');
            c.innerHTML = `<div class="section-head">Live Global Stations</div><div class="grid">${stations.map(ui_card).join('')}</div>`;
        }
        else if (view === 'browse') {
            const genres = ['Pop', 'Rock', 'Jazz', 'Techno', 'Hip Hop', 'Ambient'];
            c.innerHTML = `<div class="section-head">Explore</div><div class="grid">
                ${genres.map(g => `<div class="card" onclick="App.search('${g}')"><div style="height:100px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:24px">${g}</div></div>`).join('')}
            </div>`;
        }
        else if (view === 'podcasts') {
            const pods = await API.podcasts();
            c.innerHTML = `<div class="section-head">Trending Podcasts</div><div class="grid">${pods.map(ui_card).join('')}</div>`;
        }
        else if (view === 'liked') {
            c.innerHTML = `<div class="section-head">Liked Songs</div>
            <div style="display:flex; flex-direction:column; gap:8px">
                ${Store.liked.map((t,i) => ui_row(t,i+1)).join('')}
            </div>`;
        }
    },
    
    search: async (q) => {
        const c = document.getElementById('view-area');
        c.innerHTML = '<div class="spinner"></div>';
        const res = await API.search(q);
        c.innerHTML = `<div class="section-head">Results for "${q}"</div><div class="grid">${res.map(ui_card).join('')}</div>`;
    }
};

// UI Helpers
const ui_card = (t) => `
    <div class="card" onclick='Audio.play(${JSON.stringify(t).replace(/'/g, "&apos;")})'>
        <div class="card-img-wrap">
            <img src="${t.img}" class="card-img" loading="lazy">
            <div class="play-overlay"><div class="play-circle"><i class="ph-fill ph-play"></i></div></div>
        </div>
        <div class="c-title">${t.title}</div>
        <div class="c-sub">${t.artist}</div>
    </div>
`;

const ui_row = (t, i) => `
    <div class="list-row" onclick='Audio.play(${JSON.stringify(t).replace(/'/g, "&apos;")})'>
        <div class="l-num">${i}</div>
        <img src="${t.img}" class="l-img">
        <div>
            <div class="l-title">${t.title}</div>
            <div class="l-artist">${t.artist}</div>
        </div>
        <div><i class="ph ph-heart-fill" style="color:var(--accent)"></i></div>
    </div>
`;

// Init
App.init();
</script>
</body>
</html>
